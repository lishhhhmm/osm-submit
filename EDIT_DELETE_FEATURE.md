# Edit & Delete Existing POIs - Feature Documentation

## Overview

OSM Submit now supports **editing and deleting existing POIs** in addition to creating new ones! When you click on the map, the app checks if there's already a POI at that location.

---

## How It Works

### **1. Query Existing POIs**

When you click/select a location on the map, the app:
- Queries the **Overpass API** (OSM's query service)
- Searches for POIs within 20 meters of the clicked location
- Finds nodes and ways tagged with `amenity` or `shop`

### **2. Three Scenarios**

#### **A. No POIs Found** (Default)
- Mode: **CREATE**
- Blue banner: "Creating New POI  
"
- Empty form ready for new data
- Submit creates a new node

#### **B. Single POI Found**
- Automatically loads POI data into form
- Mode: **EDIT**
- Amber banner: "Editing Existing POI #123"
- Form pre-filled with existing data
- Submit modifies the existing feature

#### **C. Multiple POIs Found**
- Shows a selection dialog
- Lists all nearby POIs with names/types
- User picks which one to edit
- Or chooses "Create New Instead"

---

## User Flow

### **Creating New POI**
```
1. Click map location
2. No existing POIs â†’ Mode: CREATE
3. Fill form
4. Submit â†’ Creates new node
```

### **Editing Existing POI**
```
1. Click near existing POI
2. POI detected â†’ Loads data
3. Mode: EDIT
4. Modify fields
5. Submit â†’ Updates existing feature
```

### **Deleting POI**
```
1. Edit existing POI
2. Go to Review page
3. Click "Delete" button (shown in edit mode)
4. Confirm deletion
5. Submit â†’ Removes from OSM
```

---

## Technical Implementation

### **Services**

#### **overpassService.ts**
```typescript
// Query nearby POIs
queryNearbyPOIs(lat, lon, radius)

// Convert to app format
overpassToPOIData(element)

// Get display name
getPOIDisplayName(element)
```

#### **osmService.ts** (Enhanced)
```typescript
// Existing: Create new
createNode(token, env, data)

// NEW: Update existing
updateNode(token, env, data)

// NEW: Delete
deleteNode(token, env, data)
```

### **State Management**

```typescript
// App.tsx
const [mode, setMode] = useState<'create' | 'edit'>('create');
const [data, setData] = useState<POIData>({
  id?: number,        // Only present in edit mode
  version?: number,   // OSM version for updates
  lat, lon, tags
});
```

### **UI Components**

#### **POIForm**
- Shows mode banner (blue CREATE / amber EDIT)
- Displays POI ID when editing
- All fields editable in both modes

#### **ReviewSubmit**
- Edit mode: Shows DELETE button
- Create mode: Only shows SUBMIT
- Warns before deletion

---

## Data Flow

### **Edit Mode**
```
User clicks map
    â†“
Query Overpass API
    â†“
POI(s) found?
    â”œâ”€ Yes â†’ Load into form
    â”‚         Set mode = 'edit'
    â”‚         Store id & version
    â”‚
    â””â”€ No â†’  Empty form
              Set mode = 'create'
              No id/version
```

### **Submission**
```
Submit clicked
    â†“
Mode check
    â”œâ”€ CREATE â†’ POST to /api/0.6/node/create
    â”‚           (id generated by OSM)
    â”‚
    â””â”€ EDIT   â†’ PUT to /api/0.6/node/{id}
                (requires version number)
                (changeset with modify action)
```

---

## API Differences

### **Create (New)**
```xml
<osmChange>
  <create>
    <node lat="..." lon="..." changeset="...">
      <tag k="name" v="..." />
    </node>
  </create>
</osmChange>
```

### **Modify (Edit)**
```xml
<osmChange>
  <modify>
    <node id="123" version="2" lat="..." lon="..." changeset="...">
      <tag k="name" v="..." />
    </node>
  </modify>
</osmChange>
```

### **Delete**
```xml
<osmChange>
  <delete>
    <node id="123" version="2" changeset="..." />
  </delete>
</osmChange>
```

---

## Benefits

âœ… **Edit existing** - Fix mistakes, update info  
âœ… **Delete outdated** - Remove closed businesses  
âœ… **Smart detection** - Auto-finds nearby POIs  
âœ… **Version control** - Prevents edit conflicts  
âœ… **User-friendly** - Clear mode indicators  
âœ… **Safe** - Confirms before deletion  

---

## Security Notes

- **Version checking**: OSM requires version number to prevent conflicts
- **Changeset tracking**: All edits tied to changesets
- **Permissions**: User must have edit rights
- **Validation**: Can't edit without valid OAuth token

---

## Future Enhancements

- [ ] Show POI details before selecting
- [ ] Preview map location of each option
- [ ] Support editing ways (polygons)
- [ ] Bulk operations
- [ ] Conflict resolution UI

---

## Usage Tips

1. **Click precisely** - Within 20m of POI
2. **Check thoroughly** - Review loaded data
3. **Update carefully** - Other users rely on accurate data
4. **Use sandbox** - Test edits in dev environment first
5. **Add comments** - Explain significant changes

---

This makes OSM Submit a complete editing tool, not just a creation tool! ðŸŽ‰
